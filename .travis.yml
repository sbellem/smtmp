os: linux
dist: bionic
language: python
python: 3.8
sudo: true
services:
- docker
env:
  global:
  - COMMIT=${TRAVIS_COMMIT::8}
  - TEST_SET=1
  - secure: "BJIU4YNqKib3TZm2zjzf0lRwT2fyYrKJhGvjR0okZtcM1+/9kOpi3Zs1HPoakfG1l0U26KS2QlTZYPUpMXGQIl+tHvwal+Eaaznq9aqHJMp/XbZs8wVAYG/1L1mWO2Wo1EbvF/cQ1SyaQ9lwjavkidWgEbWFXA8oGVFiqVkZGghkrvkT8bcEYJYLtBLioaqrFHpUAx9sYbJs45zDF3Dyf523q8SApEjUKIRO8hOJBYobT9SkwDOZbOg1+XcdKlsLFcXnyV4qXkj9foMWc7jjZjoSd/haPayj0Q9LQeqF6HP8cCqYJE5jx4Gl3SIqfiFlQvHgRUXmHm2JK4xC8hDNeBG2AlV+SfoLdpGiYXvlQ3fgAk6GgjZEaxnFVWZs2ijI8qi0+M9NN4yZ8EF7W948OypdcZ2bogzwVA+kOvnZmr7BMyoE+/RA1D9Yey6TVaAY5SuAKsCaJTUSOc7wL1g79girbftDJS2mRSMtYVPtgB81UtIW5zwoO38Mer2sr4wnz2tVlr+gu2NOfmXIG8MOxO5v4b2VPWc6Iwk19mBcvm59C1Brm4xthpr2rGCCzrSIFQZnJA3AKSooaV1L5yMFOyt0q6ugWZv/Ip9GZnVOafWnqce48V+hCKmB8W3A0R8xEXKbtCoQ/aOkWwybwkFnVvgovyMC6trnhYYFgQPEPNw="
  - secure: "o0EZFGtmvrUACh6SgR+RiWLDmAla8QiHuRyNpuUIpKCnWKarH38SWmYniBBycZ34tCuE/HC9LvMMQpF737nrcc7gE7XnJHIIcJJkcLPkiemeQmpfun8o771Wz0Ho+YtN/EkvZ8Y568pGUgQzP0Z2+hq+HPFOpMwAf6muTbNCLJVg98q6dQWwNvov7IJOFVU0JRALEQyMTpHyncsUUWbMfo+XKrRsqyyvLu4K45cTl4Q+RI48SnqGN/1A2Abd1yaCzS5lftwxHmJjrKyMKxjfEwlJFU5NHs485ClIGNLz7Y5UGA/4YU2Y/yQEEQIZp3K97sLWD2CrTLf0c1WCoS6jhzAJIhoZstUQ91XEy+a/SAZ4ZFvquhqxciTj4kbi1ZUf+NE1wEhLj4DrkviFNQzMdtFgwzhY7nHmMls5neAN/GbX/dvP3sfdbIpzJXfwYR/8PzonNl8k8bMa5mDQDmkLkCDOSdaRuQVEZva61JT7cEUA2PhxGIVxj5GihysZdNbEfUn9M5G6TX1QEQT+GnaU0hXNOHGmnU94VS0P8jg0V9t6fP9a/RVe/MToT37Gp6Pl+8xEkJ22Yy+WY91JRZPWQwIcFD642ObdHTbpstW04U6Jk/JBw5sgD2o542lF3uBE/qVgJUlzPSzW7YsyppKEQGc55hfuwr76Rv+d+gPkaEg="
jobs:
  include:
  - stage: Build image
    install: skip
    script:
    - docker build --no-cache -t scale-mamba -f py2.Dockerfile .
    - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    - docker tag scale-mamba $DOCKER_USERNAME/scale-mamba:$COMMIT
    - docker push $DOCKER_USERNAME/scale-mamba:$COMMIT
  - stage: Tests
    name: test set 1, program batch test_array ... test_flex
    env:
    - PROGRAMS="test_array test_branch test_branching test_comparison test_empty_tape
      test_flex"
    install: skip
    script: ".ci/test-programs.sh"
  - name: test set 1, program batch test_float ... test_idle_threads
    env:
    - PROGRAMS="test_float test_floatingpoint test_float_sorting test_float_vector
      test_function test_idle_threads"
    install: skip
    script: ".ci/test-programs.sh"
  - name: test set 1, program batch test_lib ... test_sfix
    env:
    - PROGRAMS=test_lib test_loop test_mem_order test_idle_threads test_lib test_loop
      test_mem_order test_sregint test_vector test_sfix"
    install: skip
    script: ".ci/test-programs.sh"
  - name: test set 1, program batch test_sqrt ... test_all
    env:
    - PROGRAMS="test_sqrt test_custom_array test_fix_array test_all"
    install: skip
    script: ".ci/test-programs.sh"
    #- name: test set 1, program failure - "test_count"
    #  env:
    #  - PROGRAMS="test_count"
    #  install: skip
    #  script: ".ci/test-programs.sh"
    #- name: test set 1, program failure - "test_for_range_multithread"
    #  env:
    #  - PROGRAMS="test_for_range_multithread"
    #  install: skip
    #  script: ".ci/test-programs.sh"
    #- name: test set 1, program failure - "test_map_reduce"
    #  env:
    #  - PROGRAMS="test_map_reduce"
    #  install: skip
    #  script: ".ci/test-programs.sh"
    #- name: test set 1, program failure - "test_new_threads"
    #  env:
    #  - PROGRAMS="test_new_threads"
    #  install: skip
    #  script: ".ci/test-programs.sh"
    - name: test set 1, program failure - "test_threads"
      env:
      - PROGRAMS="test_threads"
      install: skip
      script: ".ci/test-programs.sh"
    #- name: test set 1, program failure - "test_math"
    #  env:
    #  - PROGRAMS="test_math"
    #  install: skip
    #  script: ".ci/test-programs.sh"
